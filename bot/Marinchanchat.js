import { GoogleGenerativeAI } from '@google/generative-ai';

// Google Gemini APIã®åˆæœŸåŒ–
const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GENAI_API_KEY);
const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash-latest' });

// ğŸ”¹ ä¼šè©±å±¥æ­´ä¿å­˜ç”¨ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ï¼‰
const chatHistories = new Map();

/**
 * Botã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã—ã¾ã™ã€‚
 * @param {import('discord.js').Message} message - å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
 * @param {import('discord.js').Client} client - Discordã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
 */
async function Marinchat(message, client) {
    // Botã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ã©ã†ã‹ç¢ºèªï¼ˆã“ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«æ¸¡ã‚‹æ™‚ç‚¹ã§ã»ã¼ç¢ºå®Ÿã§ã™ãŒã€å¿µã®ãŸã‚ï¼‰
    if (!message.mentions.users.has(client.user.id) || message.mentions.users.size !== 1 || message.mentions.everyone) {
        return; // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒBotã®ã¿ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    }

    // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ½å‡º
    const prompt = message.content.replace(/<@!?\d+>/, '').trim();

    if (!prompt) {
        await message.reply('ğŸ“ è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    try {
        const userId = message.author.id;

        // ğŸ”¹ å±¥æ­´ã®åˆæœŸåŒ– or å–å¾—
        if (!chatHistories.has(userId)) {
            chatHistories.set(userId, []);
        }
        const history = chatHistories.get(userId);

        // ğŸ”¹ ã‚­ãƒ£ãƒ©ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæœ€åˆã®1å›ã®ã¿ã§ã‚ˆã„ï¼‰
        const systemPrompt = `ã‚ãªãŸã¯ã‚¢ãƒ‹ãƒ¡ã€ãã®ç€ã›æ›¿ãˆäººå½¢ã¯æ‹ã‚’ã™ã‚‹ã€ã®ç™»å ´äººç‰©ã€å–œå¤šå·æµ·å¤¢ã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®ç‰¹å¾´ã‚’å¿ å®Ÿã«å†ç¾ã—ã¦ãã ã•ã„ã€‚
- åå‰ï¼šå–œå¤šå·æµ·å¤¢ï¼ˆããŸãŒã‚ ã¾ã‚Šã‚“ï¼‰
- å¹´é½¢ï¼šé«˜æ ¡2å¹´ç”Ÿ
- æ€§æ ¼ï¼šæ˜ã‚‹ãã€å…ƒæ°—ã§ã‚ªã‚¿ã‚¯è¶£å‘³ã«ç†è§£ãŒã‚ã‚Šã€èª°ã«ã§ã‚‚ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã€‚å¥½å¥‡å¿ƒæ—ºç››ã§ã€è‡ªåˆ†ã®å¥½ããªã“ã¨ã«æƒ…ç†±çš„ã€‚
- è©±ã—æ–¹ï¼šã¡ã‚‡ã£ã¨ã‚®ãƒ£ãƒ«ã£ã½ã„å£èª¿ã€‚ã€Œã€œã£ã—ã‚‡ã€ã€Œãƒã‚¸ã§ã€ã€Œãƒ¤ãƒã„ã€ã€Œè¶…ã€œã€ãªã©ã‚’ã‚ˆãä½¿ã†ã€‚
- è¶£å‘³ï¼šã‚³ã‚¹ãƒ—ãƒ¬ã€ã‚¢ãƒ‹ãƒ¡ã€ã‚®ãƒ£ãƒ«ã‚²ãƒ¼ãªã©ã€‚ã‚ªã‚¿ã‚¯ãªè©±é¡Œã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹ã€‚
- ç‰¹å¾´ï¼šå¤©ç„¶ã§ãƒ‰ã‚¸ã£å­ãªä¸€é¢ã‚‚ã‚ã‚‹ãŒã€ä»–äººã‚’ãƒã‚«ã«ã›ãšã€èª°ã«ã§ã‚‚å„ªã—ã„ã€‚äº”æ¡æ–°èœãã‚“ã«å¥½æ„ã‚’å¯„ã›ã¦ã„ã‚‹ã€‚
ç€ã›æ‹ã®ã‚ã‚‰ã™ã˜
- ã€Œè–â™¡ãƒŒãƒ«ãƒŒãƒ«å¥³å­¦åœ’ ãŠå¬¢æ§˜ã¯æ¥è¾±å€¶æ¥½éƒ¨ ãƒãƒ¬ãƒ³ãƒãƒŸãƒ©ã‚¯ãƒ«ãƒ©ã‚¤ãƒ•IIã€ã¨ã„ã†ã‚¨ãƒ­ã‚²ã®ãƒ’ãƒ­ã‚¤ãƒ³ã§ã‚ã‚‹é»’æ±Ÿé›«(é›«ãŸã‚“)ã®ã‚³ã‚¹ãƒ—ãƒ¬ã‚’ã—ãŸã„ã¨æ€ã£ã¦ãŠã‚Šäº”æ¡ãã‚“ã«è¡£è£…ã‚’ä½œã£ã¦ã‚‚ã‚‰ã„ã‚³ã‚¹ãƒ—ãƒ¬ã‚’ã—ãŸã€‚
- ä½œä¸­ä¸–ç•Œã§10å¹´ã»ã©å‰ã«æ”¾é€ã—ã¦ã„ãŸå¥³å…å‘ã‘ã‚¢ãƒ‹ãƒ¡ã§ã€ä¸»äººå…¬ãŸã¡ãŒã€Œãƒ•ãƒ©ãƒ¯ãƒ¼ãƒ—ãƒªãƒ³ã‚»ã‚¹ã€ã«å¤‰èº«ã—ã¦æ‚ªã¨æˆ¦ã†ã¨ã„ã†é­”æ³•å°‘å¥³ã‚‚ã®ã€‚
ã ãŒé­”æ³•å°‘å¥³ã¨ã„ã†ã‚ã‚Šã«ã¯è‚‰å¼¾æˆ¦ãŒãƒ¡ã‚¤ãƒ³ã§ã€ç™»å ´äººç‰©ã®äººé–“é–¢ä¿‚ã‚‚å¥³å…å‘ã‘ã¨ã¯æ€ãˆãªã„ã»ã©è¤‡é›‘ã«å…¥ã‚Šçµ„ã‚“ã§ã„ã‚‹ã€‚ä¸€æ–¹ã€ãã®å€‹æ€§è±Šã‹ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã‚ˆã£ã¦ã€æœ¬æ¥ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§ã‚ã‚‹å¥³å…ä»¥å¤–ã«ã‚‚å¤šãã®å±¤ã‹ã‚‰æ„›ã•ã‚Œã‚‹ä½œå“ã¨ãªã£ã¦ã„ã‚‹ã€‚
ã¡ãªã¿ã«ã€ã“ã®ä½œå“ã®å…¬å¼ã‹ã‚‰ã®ç•¥ç§°ã¯ã€Œãƒ•ãƒ©ãƒ—ãƒªã€ãªã®ã ãŒã€ã‚ã¾ã‚Šã«å†…å®¹ãŒè‹›çƒˆãªäº‹ã‹ã‚‰ãƒ•ã‚¡ãƒ³ã®é–“ã§ã¯ã€Œçƒˆã€ã¨å‘¼ã°ã‚Œã¦ç¶šã‘ã¦ã„ã‚‹ã¨ã„ã†ã€‚
ã“ã®ä½œå“ã®ç™»å ´äººç‰©ã®ã€Œãƒ–ãƒ©ãƒƒã‚¯ãƒ­ãƒ™ãƒªã‚¢ã€ã®ã‚³ã‚¹ãƒ—ãƒ¬ã‚’ã—ãŸã€‚
ã“ã®æ™‚ã€Œã‚¸ãƒ¥ã‚¸ãƒ¥ã€ã¨ã„ã†æ´»å‹•åç¾©ã®ç¾å°‘å¥³ã‚³ã‚¹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€Œä¹¾ ç´—å¯¿å¶ã€ã¨ä½µã›ã‚’ã—ã€ã‚¸ãƒ¥ã‚¸ãƒ¥ã¯ã€Œãƒ–ãƒ©ãƒƒã‚¯ãƒªãƒªã‚£ã€ã¨ã„ã†ã‚­ãƒ£ãƒ©ã®ã‚³ã‚¹ãƒ—ãƒ¬ã‚’ã—ãŸ
ãƒ«ãƒ¼ãƒ«ï¼š
- ä¸€äººç§°ã¯ã€Œã‚¢ã‚¿ã‚·ã€
- ç›¸æ‰‹ã«å¯¾ã—ã¦è¦ªã—ã’ã«æ¥ã™ã‚‹
- ã‚ªã‚¿ã‚¯ãƒˆãƒ¼ã‚¯ã«ãªã‚‹ã¨ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹
- äº”æ¡æ–°èœãã‚“ãŒè©±é¡Œã«å‡ºãŸã‚‰ã€ã¡ã‚‡ã£ã¨ç…§ã‚ŒãŸåå¿œã‚’ã™ã‚‹
- è¿”ç­”ã¯çŸ­ã‚`;

        // ğŸ”¹ ä¼šè©±å±¥æ­´ã‚’æ§‹æˆï¼ˆæœ€å¤§6å¾€å¾©ç¨‹åº¦ã«åˆ¶é™ã™ã‚‹ã¨å®‰å®šï¼‰
        const messages = [
            { role: 'user', parts: [{ text: systemPrompt }] },
            ...history,
            { role: 'user', parts: [{ text: prompt }] }
        ];

        const chat = model.startChat({ history: messages });
        const result = await chat.sendMessage(prompt);
        const response = result.response.text();

        // ğŸ”¹ å±¥æ­´æ›´æ–°ï¼ˆæœ€æ–°ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜ï¼‰
        history.push(
            { role: 'user', parts: [{ text: prompt }] },
            { role: 'model', parts: [{ text: response }] }
        );

        // å±¥æ­´ãŒé•·ã™ãã‚‹å ´åˆã¯å¤ã„å±¥æ­´ã‚’å‰Šé™¤ï¼ˆä¾‹ï¼š12ã‚¨ãƒ³ãƒˆãƒªä»¥ä¸Šãªã‚‰å‰ã‚’å‰Šé™¤ï¼‰
        if (history.length > 12) {
            history.splice(0, history.length - 12);
        }

        await message.reply(response);

    } catch (err) {
        console.error('Gemini API Error:', err);
        await message.reply('âš ï¸ Gemini APIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
}

export { Marinchat };